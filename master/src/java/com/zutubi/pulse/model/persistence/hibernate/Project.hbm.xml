<?xml version="1.0"?>
<!DOCTYPE hibernate-mapping PUBLIC "-//Hibernate/Hibernate Mapping DTD//EN" "http://hibernate.sourceforge.net/hibernate-mapping-3.0.dtd" >
<hibernate-mapping>

    <class name="com.zutubi.pulse.model.Project" table="PROJECT" lazy="false">
        <cache usage="read-write"/>

        <id name="id" type="java.lang.Long" column="ID" unsaved-value="0">
            <generator class="hilo"/>
        </id>

        <property name="name" column="NAME" type="string" length="255"/>

        <property name="description" column="DESCRIPTION" type="string" length="4095"/>

        <property name="url" column="URL" type="string" length="511"/>

        <property name="stateName" column="STATE" type="string" length="31"/>

        <many-to-one name="pulseFileDetails" class="com.zutubi.pulse.model.PulseFileDetails" column="BOB_FILE_DETAILS" lazy="false" cascade="all"/>

        <bag name="buildSpecifications" cascade="all,delete-orphan" lazy="false">
            <cache usage="read-write"/>
            <key column="PROJECT_ID"/>
            <one-to-many class="com.zutubi.pulse.model.BuildSpecification"/>
        </bag>

        <many-to-one name="defaultSpecification" class="com.zutubi.pulse.model.BuildSpecification" column="DEFAULT_SPECIFICATION" lazy="false" cascade="none"/>

        <bag name="postBuildActions" cascade="all,delete-orphan" lazy="false">
            <cache usage="read-write"/>
            <key column="PROJECT_ID"/>
            <one-to-many class="com.zutubi.pulse.model.PostBuildAction"/>
        </bag>

        <bag name="cleanupRules" cascade="all,delete-orphan" lazy="false">
            <cache usage="read-write"/>
            <key column="PROJECT_ID"/>
            <one-to-many class="com.zutubi.pulse.model.CleanupRule"/>
        </bag>

        <many-to-one name="scm" class="com.zutubi.pulse.model.Scm" column="SCM" cascade="all" lazy="false"/>

        <many-to-one name="changeViewer" class="com.zutubi.pulse.model.ChangeViewer" column="CHANGE_VIEWER" cascade="all" lazy="false"/>

        <bag name="aclEntries" inverse="true" cascade="all,delete-orphan" lazy="false">
            <cache usage="read-write"/>
            <key column="PROJECT_ID"/>
            <one-to-many class="com.zutubi.pulse.model.ProjectAclEntry"/>
        </bag>

        <property name="nextBuildNumber" column="NEXT_BUILD_NUMBER" type="long"/>
        
    </class>

    <class name="com.zutubi.pulse.model.ChangeViewer" table="CHANGE_VIEWER" lazy="false">
        <cache usage="read-write"/>

        <id name="id" type="java.lang.Long" column="ID" unsaved-value="0">
            <generator class="hilo"/>
        </id>

        <discriminator column="TYPE" type="string" length="63"/>

        <subclass name="com.zutubi.pulse.model.CustomChangeViewer" discriminator-value="CUSTOM" lazy="false">
            <property name="changesetURL" type="string" length="511"/>
            <property name="fileViewURL" type="string" length="511"/>
            <property name="fileDownloadURL" type="string" length="511"/>
            <property name="fileDiffURL" type="string" length="511"/>
        </subclass>

        <subclass name="com.zutubi.pulse.model.FisheyeChangeViewer" discriminator-value="FISHEYE" lazy="false">
            <property name="baseURL" type="string" length="511"/>
            <property name="projectPath" type="string" length="511"/>
        </subclass>

        <subclass name="com.zutubi.pulse.model.P4WebChangeViewer" discriminator-value="P4WEB" lazy="false">
            <property name="baseURL" type="string" length="511"/>
            <property name="projectPath" type="string" length="511"/>
        </subclass>

        <subclass name="com.zutubi.pulse.model.TracChangeViewer" discriminator-value="TRAC" lazy="false">
            <property name="baseURL" type="string" length="511"/>
            <property name="projectPath" type="string" length="511"/>
        </subclass>

        <subclass name="com.zutubi.pulse.model.ViewVCChangeViewer" discriminator-value="VIEWVC" lazy="false">
            <property name="baseURL" type="string" length="511"/>
            <property name="projectPath" type="string" length="511"/>
        </subclass>
    </class>

    <class name="com.zutubi.pulse.model.ProjectAclEntry" table="PROJECT_ACL_ENTRY" lazy="false">
        <cache usage="read-write"/>

        <id name="id" type="java.lang.Long" column="ID" unsaved-value="0">
            <generator class="hilo"/>
        </id>

        <property name="recipient" type="string" length="511"/>

        <property name="mask" type="int"/>

        <many-to-one name="aclObjectIdentity" column="PROJECT_ID" class="com.zutubi.pulse.model.Project" not-null="true"/>
    </class>

    <class name="com.zutubi.pulse.model.PulseFileDetails" table="BOB_FILE_DETAILS" lazy="false">
        <cache usage="read-write"/>

        <id name="id" type="java.lang.Long" column="ID" unsaved-value="0">
            <generator class="hilo"/>
        </id>

        <discriminator column="SOURCE_TYPE" type="string" length="63"/>

        <subclass name="com.zutubi.pulse.model.CustomPulseFileDetails" discriminator-value="CUSTOM" lazy="false">
            <property name="pulseFile" column="PULSE_FILE" type="text"/>
        </subclass>

        <subclass name="com.zutubi.pulse.model.VersionedPulseFileDetails" discriminator-value="VERSIONED" lazy="false">
            <property name="pulseFileName" column="PULSE_FILE_NAME" type="string" length="255"/>
        </subclass>

        <subclass name="com.zutubi.pulse.model.TemplatePulseFileDetails" lazy="false">
            <bag name="captures" cascade="all,delete-orphan" lazy="false">
                <cache usage="read-write"/>
                <key column="DETAILS_ID"/>
                <one-to-many class="com.zutubi.pulse.model.Capture"/>
            </bag>

            <bag name="outputProcessors" table="OUTPUT_PROCESSORS" lazy="false">
                <cache usage="read-write"/>
                <key column="DETAILS_ID"/>
                <element type="string" column="PROCESSOR" not-null="true"/>
            </bag>

            <subclass name="com.zutubi.pulse.model.AntPulseFileDetails" discriminator-value="ANT" lazy="false">
                <property name="buildFile" column="BUILD_FILE" type="string" length="255"/>
                <property name="targets" column="TARGETS" type="string" length="255"/>
                <property name="arguments" column="ARGUMENTS" type="string" length="1023"/>
                <property name="workingDir" column="WORKING_DIR" type="string" length="255"/>
                <map name="environment" lazy="false" table="ANT_SOURCE_ENVIRONMENT" cascade="all">
                    <cache usage="read-write"/>
                    <key column="SOURCE_ID"/>
                    <index column="NAME" type="string" length="255"/>
                    <element type="text" column="VALUE"/>
                </map>
            </subclass>

            <subclass name="com.zutubi.pulse.model.BJamPulseFileDetails" discriminator-value="BJAM" lazy="false">
                <property name="jamfile" column="MAKEFILE" type="string" length="255"/>
                <property name="targets" column="TARGETS" type="string" length="1023"/>
                <property name="arguments" column="ARGUMENTS" type="string" length="1023"/>
                <property name="workingDir" column="WORKING_DIR" type="string" length="1023"/>
            </subclass>

            <subclass name="com.zutubi.pulse.model.ExecutablePulseFileDetails" discriminator-value="EXE" lazy="false">
                <!-- Overlap columns with other subtypes -->
                <property name="executable" column="BUILD_FILE" type="string" length="255"/>
                <property name="arguments" column="ARGUMENTS" type="string" length="1023"/>
                <property name="workingDir" column="WORKING_DIR" type="string" length="255"/>
                <map name="environment" lazy="false" table="EXE_SOURCE_ENVIRONMENT" cascade="all">
                    <cache usage="read-write"/>
                    <key column="SOURCE_ID"/>
                    <index column="NAME" type="string" length="255"/>
                    <element type="text" column="VALUE"/>
                </map>
            </subclass>

            <subclass name="com.zutubi.pulse.model.MakePulseFileDetails" discriminator-value="MAKE" lazy="false">
                <property name="makefile" column="MAKEFILE" type="string" length="255"/>
                <property name="targets" column="TARGETS" type="string" length="1023"/>
                <property name="arguments" column="ARGUMENTS" type="string" length="1023"/>
                <property name="workingDir" column="WORKING_DIR" type="string" length="1023"/>
                <map name="environment" lazy="false" table="MAKE_SOURCE_ENVIRONMENT" cascade="all">
                    <cache usage="read-write"/>
                    <key column="SOURCE_ID"/>
                    <index column="NAME" type="string" length="255"/>
                    <element type="text" column="VALUE"/>
                </map>
            </subclass>

            <subclass name="com.zutubi.pulse.model.MavenPulseFileDetails" discriminator-value="MAVEN" lazy="false">
                <property name="workingDir" column="BASE_DIR" type="string" length="1023"/>
                <property name="targets" column="TARGETS" type="string" length="1023"/>
                <property name="arguments" column="ARGUMENTS" type="string" length="1023"/>
            </subclass>

            <subclass name="com.zutubi.pulse.model.Maven2PulseFileDetails" discriminator-value="MAVEN2" lazy="false">
                <property name="workingDir" column="BASE_DIR" type="string" length="1023"/>
                <!-- Use a targets column so that it overlaps with other subtypes -->
                <property name="goals" column="TARGETS" type="string" length="1023"/>
                <property name="arguments" column="ARGUMENTS" type="string" length="1023"/>
            </subclass>

            <subclass name="com.zutubi.pulse.model.XCodePulseFileDetails" discriminator-value="XCODE" lazy="false">
                <property name="workingDir" column="BASE_DIR" type="string" length="1023"/>
                <property name="target" column="TARGETS" type="string" length="1023"/>
                <property name="project" column="PROJECT" type="string" length="1023"/>
                <property name="config" column="CONFIG" type="string" length="1023"/>
                <property name="action" column="BUILDACTION" type="string" length="1023"/>
                <property name="settings" column="ARGUMENTS" type="string" length="1023"/>
            </subclass>

        </subclass>
    </class>

    <class name="com.zutubi.pulse.model.Capture" table="CAPTURE">
        <cache usage="read-write"/>

        <id name="id" type="java.lang.Long" column="ID" unsaved-value="0">
            <generator class="hilo"/>
        </id>

        <discriminator column="TYPE" type="string" length="31"/>

        <property name="name" type="string" length="255"/>

        <bag name="processors" table="CAPTURE_PROCESSORS" lazy="false">
            <cache usage="read-write"/>
            <key column="CAPTURE_ID"/>
            <element type="string" column="PROCESSOR" not-null="true" length="255"/>
        </bag>

        <subclass name="com.zutubi.pulse.model.DirectoryCapture" discriminator-value="DIRECTORY" lazy="false">
            <property name="base" type="string" length="4095"/>
            <property name="includes" type="string" length="4095"/>
            <property name="excludes" type="string" length="4095"/>
            <property name="mimeType" type="string" length="4095"/>
        </subclass>

        <subclass name="com.zutubi.pulse.model.FileCapture" discriminator-value="FILE" lazy="false">
            <property name="file" type="string" length="4095"/>
            <property name="mimeType" type="string" length="255"/>
        </subclass>
    </class>

    <class name="com.zutubi.pulse.model.PostBuildAction" table="POST_BUILD_ACTION">
        <cache usage="read-write"/>

        <id name="id" type="java.lang.Long" column="ID" unsaved-value="0">
            <generator class="hilo"/>
        </id>

        <discriminator column="TYPE" type="string" length="255"/>

        <property name="name" type="string" length="255"/>

        <bag name="specifications" table="POST_BUILD_ACTION_SPECIFICATIONS" lazy="false">
            <cache usage="read-write"/>
            <key column="ACTION_ID"/>
            <many-to-many class="com.zutubi.pulse.model.BuildSpecification" column="SPECIFICATION_ID"/>
        </bag>

        <property name="statesString" type="string" length="255"/>

        <property name="failOnError" type="boolean"/>

        <subclass name="com.zutubi.pulse.model.EmailCommittersPostBuildAction" discriminator-value="EMAIL" lazy="false">
            <property name="emailDomain" column="EMAIL_DOMAIN" type="string" length="255"/>
            <property name="template" column="TEMPLATE" type="string" length="63"/>
            <property name="ignorePulseUsers" column="IGNORE_PULSE_USERS" type="boolean"/>
        </subclass>

        <subclass name="com.zutubi.pulse.model.RunExecutablePostBuildAction" discriminator-value="EXECUTABLE" lazy="false">
            <property name="command" type="string" length="255"/>
            <property name="arguments" type="text"/>
        </subclass>

        <subclass name="com.zutubi.pulse.model.TagPostBuildAction" discriminator-value="TAG" lazy="false">
            <property name="tag" type="string" length="255"/>
            <property name="moveExisting" type="boolean"/>
        </subclass>
    </class>

    <class name="com.zutubi.pulse.model.CleanupRule" table="CLEANUP_RULE" lazy="false">
        <cache usage="read-write"/>

        <id name="id" type="java.lang.Long" column="ID" unsaved-value="0">
            <generator class="hilo"/>
        </id>

        <property name="workDirOnly" type="boolean"/>

        <property name="stateNames" type="string" length="255"/>

        <property name="limit" column="RULE_LIMIT" type="int"/>

        <property name="unitName" type="string" length="255"/>
    </class>

    <query name="findAllProjectsCached" cacheable="true"><![CDATA[
        from Project project
    ]]></query>

    <query name="findByLikeName"><![CDATA[
        from Project project
        where project.name like :name
    ]]></query>

    <query name="findByName" cacheable="true"><![CDATA[
        from Project project
        where project.name = :name
    ]]></query>

    <query name="findByScm"><![CDATA[
        from Project project
        where project.scm = :scm
    ]]></query>

    <query name="findByScmId"><![CDATA[
        from Project project
        where project.scm.id = :scmId
    ]]></query>

    <query name="findProjectByBuildSpecification" cacheable="true"><![CDATA[
        from Project project
        where :buildSpecification in elements(project.buildSpecifications)
    ]]></query>

    <query name="findProjectByCleanupRule"><![CDATA[
        from Project project
        where :cleanupRule in elements(project.cleanupRules)
    ]]></query>

    <query name="findByAcl"><![CDATA[
        select project
        from Project project
        join project.aclEntries acl
        where acl.recipient = :recipient
    ]]></query>


</hibernate-mapping>