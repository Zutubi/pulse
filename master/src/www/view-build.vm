#macro(detailrow $header $content)
  <tr><th class="command-detail">$header</th><td class="command-detail">$content</td></tr>
#end

#macro(errordetails $result)
  #if($result.errorMessage)
    <h2 class="command-element">error details</h2>
    #set($trace = $result.exceptionTrace)
    <div class="error">
    #if($result.errorMessage)
      <h3>message</h3>
      <pre>$result.errorMessage</pre>
    #end
    #if($trace)
      <h3>full trace</h3>
      <pre>$trace</pre>
    #end
    </div>
  #end      
#end

#macro(errorrow $result)
  #if($result.errored() && $result.errorMessage)
    <tr>
      <td class="build-failure" colspan="4">
        <h4>error message</h4>
        <ul class="error">
          <li class="error">$result.errorMessage</li>
        </ul>
      </td>
    </tr>
  #end
#end

#macro(resultsummary $result)
  #if(!$result.commenced())
    #set($class = "pending")
  #elseif($result.inProgress())
    #set($class = "info")
  #elseif($result.succeeded())
    #set($class = "success")
  #else
    #set($class = "failure")
  #end

  <tr>
    <th class="command-detail">commenced</th>
    <th class="command-detail">completed</th>
    <th class="command-detail">elapsed</th>
    <th class="command-detail">status</th>
  </tr>
  <tr>
    <td class="build-$class">$result.stamps.prettyStartTime</td>
    <td class="build-$class">$result.stamps.prettyEndTime</td>
    <td class="build-$class">$result.stamps.prettyElapsed</td>
    <td class="build-$class">$result.state.prettyString</td>
  <tr>

  #errorrow($result)
#end

<html>
  <head>
    <title>$project.name build $result.number</title>
    <link href="build.css" rel="stylesheet" type="text/css">
  </head>
  <body>
    <h1 class="build-log">:: build $result.number ::</h1>
#if($result.inProgress())
  #set($class = "info")
#elseif($result.succeeded())
  #set($class = "success")
#else
  #set($class = "failure")
#end

    <h2 class="command-$class">summary</h2>
    <div class="command-content">
      <table>
        #resultsummary($result)
      </table>
    </div>

      <h2 class="command-info">changes</h2>
      <div class="command-content">
        #foreach($scmDetails in $result.scmDetails.values())
          #if($scmDetails.revision)
            <table>
              <tr>
                <th class="build-info" colspan="4">$scmDetails.scmName</th>
              </tr>
              <tr>
                <th class="command-detail" colspan="4">
                  checked out revision $scmDetails.revision
                </th>
              </tr>
            #set($changes = $scmDetails.changelists)
	        #if($changes.size() > 0)
                  <tr>
                    <th class="command-detail">revision</th>
                    <th class="command-detail">who</th>
                    <th class="command-detail">when</th>
                    <th class="command-detail">comment</th>
                  </tr>
              #foreach($change in $changes)
                <tr>
                  <td class="command-detail"><a href="viewChangelist.action?id=$change.id">$change.revision</a></td>
                  <td class="command-detail">$change.user</td>
                  <td class="command-detail">$change.date</td>
                  <td class="command-detail">$change.comment</td>
                </tr>
              #end
            #else
              <tr>
                <td class="command-detail" colspan="4">
                  no changes since last build
                </td>
              </tr>
            #end
            </table>
	      #end
	    #end
	  </div>

#macro(showrecipes $node)
  <ul>
  #foreach($child in $node.children)
    #set($recipeResult = $child.result)

    #if($recipeResult.recipeName)
      #set($recipeName = $recipeResult.recipeName)
    #else
      #set($recipeName = "[default]")
    #end
    <li>
      <table>
        <tr>
          <th colspan="4" class="command-detail">$recipeName @ $child.host</th>
        </tr>
    #if($recipeResult.commenced())
      #resultsummary($result)
    #end

    #if($recipeResult.commandResults.size() > 0)
        <tr>
          <th class="command-detail">command</th>
          <th class="command-detail">elapsed</th>
          <th class="command-detail">status</th>
          <th class="command-detail">artifacts</th>
        </tr>
      #foreach($commandResult in $recipeResult.commandResults)
        #if(!$commandResult.commenced())
          #set($commandClass = "pending")
        #elseif($commandResult.inProgress())
          #set($commandClass = "info")
        #elseif($commandResult.succeeded())
          #set($commandClass = "success")
        #else
          #set($commandClass = "failure")
        #end
        <tr>
          <td class="build-$commandClass">$commandResult.commandName</td>
          <td class="build-$commandClass">$commandResult.stamps.prettyElapsed</td>
          <td class="build-$commandClass">$commandResult.state.prettyString</td>
          <td class="build-$commandClass">
            #if($commandResult.artifacts.size() > 0)
              <ul class="artifact">
              #foreach($artifact in $commandResult.artifacts)
                <li class="artifact"><a href="viewArtifact.action?id=$artifact.id&commandId=$commandResult.id">$artifact.name</a></li>
              #end
              </ul>
            #else
              [none]
            #end
          </td>
        </tr>
        #errorrow($recipeResult)
      #end
    #end
      </table>
    #if($child.children.size() > 0)
      #showrecipes($child)
    #end
  #end
  </ul>
#end

    <h2 class="command-$class">recipe results</h2>
    <div class="command-content">
      <span id="build-tree">
        #showrecipes($result.root)
      </span>
    </div>
<!--
#foreach($commandResult in $recipeResult.commandResults)
  #if($commandResult.inProgress())
    #set($class = "info")
  #elseif($commandResult.succeeded())
    #set($class = "success")
  #else
    #set($class = "failure")
  #end
    <h2 class="command-$class">$commandResult.commandName</h2>
    <div class="command-content">
      <table>
        #detailrow("commenced" $commandResult.stamps.prettyStartTime)
        #detailrow("completed" $commandResult.stamps.prettyEndTime)
        #detailrow("elapsed"   $commandResult.stamps.prettyElapsed)
        #detailrow("status"    $commandResult.state.prettyString)
      </table>
      #if($commandResult.errorMessage)
        #errordetails($commandResult)
      #else
        <h2 class="command-element">details</h2>
        <table>
          #foreach($key in $commandResult.properties.keySet())
            #detailrow($key $commandResult.properties.get($key))
          #end
        </table>
        <h2 class="command-element">artifacts</h2>
        #foreach($artifact in $commandResult.artifacts)
          <h3>$artifact.title (<a href="viewArtifact.action?id=$artifact.id">view</a>)</h3>
          <div class="artifact">
          #if($artifact.hasFeatures())
            #foreach($level in $artifact.levels)
            <div class="$level.toString().toLowerCase()">
              <b>$level.toString().toLowerCase() features</b>
              <ul class="feature">
              #foreach($feature in $artifact.getFeatures($level))
                <li>$feature.summary</li>
              #end
              </ul>
            </div>
            #end
          #else
            &lt;No features&gt;
          #end
          </div>
        #end
      #end
    </div>
#end
-->
  </body>
</html>
