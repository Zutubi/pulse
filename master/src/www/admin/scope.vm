#authorisationTags($principle)
<content tag="selectedTab">$section</content>
<html>
<head>
    <title>#wwtext("name=${section}")</title>
	<script type="text/javascript">
        var tree;
        
        var onSelect = function(sm, node)
        {
            if(node)
            {
                Ext.get('detail-pane').load({url: tree.loader.getNodePath(node), scripts:true});
            }
        }

        var handleConfigurationResponse = function(result)
        {
            if(result.success)
            {
                if(result.newPanel)
                {
                    Ext.get('detail-pane').update(result.newPanel, true);
                }
                tree.handleResponse(result);
                tree.redirectToNewPath(result);
            }
        }

        var getAjaxCallback = function(maskedElement)
        {
            return {
                success: function(response) { handleConfigurationResponse(Ext.decode(response.responseText)); if(maskedElement) { maskedElement.unmask() } },
                failure: function(response) { if(maskedElement) { maskedElement.unmask() } }
            }
        }

        var runAjaxRequest = function(url)
        {
            var pane = Ext.get('detail-pane');
            pane.mask('Please wait...');
            Ext.lib.Ajax.request('get', url, getAjaxCallback(pane));
        }

        var selectPath = function(path)
        {
            tree.getSelectionModel().clearSelections();
            tree.selectConfigPath(path);
        }

        var editPath = function(path)
        {
            Ext.get('detail-pane').load({url: '$base/aconfig/' + path, scripts:true});
        }

        var addToPath = function(path)
        {
            runAjaxRequest('$base/aconfig/' + path + '?wizard');
        }

        var actionPath = function(path)
        {
            // ajax actions are executed in place. so that we know where to refresh to, we
            // first need to know where we are.
            var detailPane = Ext.get('detail-pane').getUpdateManager().defaultUrl;
            var oldPath = detailPane.substring('$base/aconfig/'.length, detailPane.length);
            
            runAjaxRequest('$base/aconfig/' + path + '=input&newPath=' + oldPath);
        }

        var deletePath = function(path)
        {
            runAjaxRequest('$base/aconfig/' + path + '?delete=confirm');
        }

        var Layout = function()
        {
            var centerRegion;
#if($path)
            var path = '$path';
#else
            var path = '';
#end

            return {
                init : function()
                {
                    centerRegion = nestedLayout.getRegion('center');
                    var centerPanel = centerRegion.getPanel(0);
                    centerPanel.setTitle('');
                    centerPanel.getEl().setStyle('margin', '4px');

                    nestedLayout.addRegion('north', {
                        split: false,
                        titlebar: false
                    });

                    nestedLayout.addRegion('west', {
                        split:true,
                        initialSize: 300,
                        titlebar: false,
                        collapsible: true,
                        animate: true,
                        tabPosition: 'bottom',
                        autoScroll: true
                    });

                    var loader = new ZUTUBI.ConfigTreeLoader('$base/aconfig');
                    //loader.on('loadexception', function(loader, node, response) {  console.dir(response); });

                    tree = new ZUTUBI.ConfigTree('config-tree', {
#if($prefixPath)
                        pathPrefix: '$prefixPath',
 #end
                        animate: false,
                        loader: loader,
                        title: 'config'
                    });

                    var root = new Ext.tree.AsyncTreeNode({
                        id: '${tab}',
                        text: '${tab}',
                        allowDrag: false,
                        allowDrop: false
                    });
                    
                    tree.setRootNode(root);
                    tree.getSelectionModel().on('selectionchange', onSelect);

                    nestedLayout.beginUpdate();
                    nestedLayout.add('north', new Ext.ContentPanel('innernorth', {title: 'inner north'}));
                    nestedLayout.add('west', new Ext.ContentPanel('config-tree', {}));
                    nestedLayout.endUpdate();

                    tree.render();
                    if (path && path != 'global')
                    {
                        tree.selectConfigPath(path);
                    }
                    else
                    {
                        tree.selectConfigPath('global/emailConfig');
                    }
                    root.expand();
                }
            }
        }();
        
        Ext.onReady(Layout.init, Layout, true);
	</script>
</head>
<body>
#if($section == "administration")
    #adminTabs("${tab}")
#else
    #dashboardTabs("${tab}")
#end

    <div id="innernorth" style="padding: 0px;">
    </div>

    <div id="config-tree" style="padding: 10px">
    </div>

    <div id="detail-pane" style="padding: 10px; min-height: 100%">
        #parse("/template/includes/actionerrors.vm")
    </div>
</body>
</html>
