#macro(nodeResources $node)
    <table class="content" id="resources_$!webwork.htmlEncode($node.stage.name)">
        #headingRow("buildspec.stage.resources" 4)
        <tr>
            #contentHeading("resource.name" 1)
            #contentHeading("resource.version" 1)
    #acl("domainObject=project" "hasPermission=4,1")
            #contentHeading("actions" 2)
    #end
        </tr>
    #foreach($resource in $node.resourceRequirements)
        #set($confirmMessage = $action.getText("buildspec.stage.resource.confirm.delete"))
        <tr>
            #dynamicCell($resource.resource)
            #dynamicCell($resource.version)
        #acl("domainObject=project" "hasPermission=4,1")
            #editCell("editBuildStageResource!input.action?projectId=$project.id&amp;specId=$specification.id&amp;id=$node.id&amp;index=$velocityCount" "edit_resource_${node.id}_${velocityCount}")
            #deleteCell("delete_resource_${node.id}_${velocityCount}" "deleteBuildStageResource.action?projectId=$project.id&amp;specId=$specification.id&amp;id=$node.id&amp;index=$velocityCount" $confirmMessage)
        #end
        </tr>
    #end
    #acl("domainObject=project" "hasPermission=4,1")
         #addRow("buildspec.stage.resource.add" 4 "addBuildStageResource!input.action?projectId=$project.id&amp;specId=$specification.id&amp;id=$node.id" "resource.add_$node.id")
    #end
    </table>
#end

#helpTag("Project+Build+Specifications")
#authorisationTags($principle)
#projectTags($project)
<html>
<head>
    <title>$!webwork.htmlEncode($specification.name)</title>
    <script type="text/javascript">
#if($action.haveSelectedNode() || $specification.root.children.size() == 0)
        var selectedNode = "$selectedNode";
#else
        var selectedNode = "$specification.root.children.get(0).id";
#end
    </script>
</head>
<body>
    #projectTabs("configuration")

    <h2 class="section">#wwtext("name=buildspec") $!webwork.htmlEncode($specification.name)</h2>

    <table id="spec.basics" class="content">
        #aclEditHeadingRow("buildspec.basics" 2 "editBuildSpecification!input.action?projectId=$project.id&amp;id=$specification.id" "edit_basics" "project")
        #dynamicRow("buildspec.name" $specification.name)
        #dynamicRow("buildspec.isolate.changelists" $specification.isolateChangelists)
        #dynamicRow("buildspec.retain.working.copy" $specification.retainWorkingCopy)
        #dynamicRow("buildspec.timeout" $specification.prettyTimeout)
    </table>

    #nodeResources($specification.root)

    <h2 class="twopane">#wwtext("name=buildspec.stages")</h2>

    <table class="twopane">
        <tr>
            <td class="leftpane">
                <p>
                    Select a stage:
                </p>
                <ul class="panenav">
    #foreach($node in $specification.root.children)
                    <li>
                        <a href="#" id="nav_$node.id" onclick="selectNode('$node.id'); return false;">
                            $!webwork.htmlEncode($node.stage.name)
                        </a>
                    </li>
    #end
                </ul>
#acl("domainObject=project" "hasPermission=4,1")
                <p>
                    <a id="stage.add" href="createBuildStage!input.action?projectId=$projectId&specId=$specification.id">
                        <img alt="add" src="/images/add.gif"/> #wwtext("name=buildspec.stage.add")
                    </a>
                </p>
#end
            </td>
            <td class="rightpane">
    #foreach($node in $specification.root.children)
        #set($confirmMessage = $action.getText("buildspec.stage.confirm.delete", [$node.stage.name]))
                <div id="node_$node.id" style="display: none">
                    <div class="panecontent">
                        <table id="stage_$!webwork.htmlEncode($node.stage.name)" class="content">
                            #aclEditHeadingRow("buildspec.stage.basics" 2 "editBuildStage!input.action?projectId=$project.id&amp;specId=$specification.id&amp;id=$node.id" "edit_$node.id" "project")
                            #dynamicRow("buildspec.stage.name" $node.stage.name)
                            #dynamicRow("buildspec.stage.recipe" $node.stage.recipeSafe)
                            #dynamicRow("buildspec.stage.agent" $node.stage.hostRequirements.summary)
                        </table>
                        #nodeResources($node)
        #acl("domainObject=project" "hasPermission=4,1")
                        <a href="#" id="delete_$!webwork.htmlEncode($node.stage.name)" onclick="confirmUrl('$confirmMessage', 'deleteBuildStage.action?projectId=$project.id&amp;specId=$specification.id&amp;id=$node.id')">
                            <img alt="$action.getText('delete')" src="/images/delete.gif"/> #wwtext("name=buildspec.stage.delete")
                        </a>
        #end
                    </div>
                </div>
    #end
            </td>
        </tr>
    </table>

#if($specification.root.children.size() > 0)
    <script type="text/javascript">
        selectNode(selectedNode);
    </script>
#end

    #tabEnd()
</body>
</html>
