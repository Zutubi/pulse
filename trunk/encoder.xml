<?xml version="1.0" encoding="UTF-8"?>
<project name="license encoding" basedir=".">

    <!-- initialise configuration -->
    <target name="init">

        <property name="src.dir" value="master/src/java"/>
        <property name="core.src.dir" value="core/src/java"/>

        <property name="build.dir" value="build"/>
        <property name="build.lib.dir" value="build/lib"/>
        <property name="classes.dir" value="${build.dir}/classes"/>

        <!-- library paths. -->
        <fileset id="module.libs" dir="${build.lib.dir}">
            <include name="**/*.jar"/>
        </fileset>

        <path id="lib.path">
            <fileset refid="module.libs"/>
        </path>

    </target>

    <!-- clean dependencies -->
    <target name="clean" depends="init">
        <delete dir="${build.dir}"/>
    </target>

    <!-- prepare for new build -->
    <target name="prepare" depends="init">

        <!-- create necessary directories -->
        <mkdir dir="${build.dir}"/>
        <mkdir dir="${build.lib.dir}"/>
        <mkdir dir="${classes.dir}"/>

        <!-- TODO: need to make this system independent -->
        <copy todir="${build.lib.dir}">
            <fileset dir="lib">
                <include name="commons-codec-1.3.jar"/>
            </fileset>
        </copy>

    </target>

    <!-- execute the common portion of the build. -->
    <target name="build" depends="prepare">

        <javac srcdir="${core.src.dir}" destdir="${classes.dir}" debug="true">
            <classpath refid="lib.path"/>
            <include name="**/ObjectUtils.java"/>
            <include name="**/Constants.java"/>
            <include name="**/PulseException.java"/>
        </javac>

        <javac srcdir="${src.dir}" destdir="${classes.dir}" debug="true">
            <classpath refid="lib.path"/>
            <classpath location="${classes.dir}"/>
            <include name="**/LicenseEncoder.java"/>
            <include name="**/LicenseType.java"/>
            <include name="**/LicensingException.java"/>
        </javac>

    </target>

    <target name="jar" depends="build">

        <unzip src="${build.lib.dir}/commons-codec-1.3.jar" dest="${classes.dir}"/>

        <jar file="build/encoder.jar" basedir="${classes.dir}">
            <exclude name="**/*.html"/>
            <exclude name="**/*.txt"/>
            <manifest>
                <attribute name="Main-Class" value="com.zutubi.pulse.license.LicenseEncoder"/>
            </manifest>
        </jar>
    </target>

    <target name="check">
        <java jar="build/encoder.jar" fork="true">
            <arg value="EVALUATION"/> <!-- license type -->
            <arg value="S O MeBody"/> <!-- license holder -->
            <arg value="2001-10-10 10:10:10"/> <!-- license expiry -->
        </java>
    </target>

    <target name="package" depends="prepare, jar, check"/>

    <!-- Dependency management. -->
<!--
    <target name="dep-init" description="Initializes some properties">

        <mkdir dir="${user.home}/.maven/repository"/>
        <condition property="noget">
            <equals arg1="${build.sysclasspath}" arg2="only"/>
        </condition>

        <available property="Junit.present" classname="junit.framework.Test"/>

        <condition property="useProxy">
            <and>
                <isset property="proxy.host"/>
                <not>
                    <equals trim="true" arg1="${proxy.host}" arg2=""/>
                </not>
            </and>
        </condition>
    </target>

    <target name="setProxy" if="useProxy" depends="init">
        <echo>Proxy used :</echo>
        <echo>Proxy host [${proxy.host}]</echo>
        <echo>Proxy port [${proxy.port}]</echo>
        <echo>Proxy user [${proxy.username}]</echo>
        <setproxy proxyuser="${proxy.username}" proxyport="${proxy.port}" proxypassword="${proxy.password}" proxyhost="${proxy.host}"/>
    </target>

    <target name="noProxy" unless="useProxy" depends="init">
        <echo>Proxy not used.</echo>
    </target>

    <target name="get-deps" unless="noget" depends="get-dep-commons-codec.jar"/>

    <target name="get-dep-commons-codec.jar" description="Download the dependency : commons-codec.jar" unless="commons-codec.jar" depends="dep-init, setProxy, noProxy, get-custom-dep-commons-codec.jar">
        <mkdir dir="${user.home}/.maven/repository/commons-codec/jars/"/>
        <get dest="${user.home}/.maven/repository/commons-codec/jars/commons-codec-1.3.jar" usetimestamp="true" ignoreerrors="true" src="http://www.ibiblio.org/maven/commons-codec/jars/commons-codec-1.3.jar"/>
    </target>

    <target name="get-custom-dep-commons-codec.jar" if="commons-codec.jar" depends="dep-init, setProxy, noProxy">
        <mkdir dir="${user.home}/.maven/repository/commons-codec/jars/"/>
        <get dest="${user.home}/.maven/repository/commons-codec/jars/commons-codec-1.3.jar" usetimestamp="true" ignoreerrors="true" src="${commons-codec.jar}"/>
    </target>
-->

</project>
