<?xml version="1.0" encoding="UTF-8"?>
<project name="common" basedir="." default="build.plugin">

    <!-- initialise configuration -->
    <target name="init" depends="module-pre-init, common-init, module-post-init"/>

    <target name="module-pre-init"/>

    <target name="module-post-init"/>

    <target name="common-init">

        <echo message="-----------------------------------"/>
        <echo message="    Component: init ${module}"/>
        <echo message="-----------------------------------"/>

        <property name="module.root.dir" value="${project.root.dir}/${module}"/>

        <property name="src.dir" value="${module.root.dir}/src"/>
        <property name="etc.dir" value="${module.root.dir}/etc"/>
        <property name="build.dir" value="${module.root.dir}/build"/>
        <property name="classes.dir" value="${build.dir}/classes"/>
        <property name="package.dir" value="${build.dir}/package"/>

        <property name="repository" value="${project.root.dir}/plugins"/>

        <property name="plugin.jar" value="${module.root.dir}/build/${module}.jar"/>
        <property name="plugin.zip" value="${module.root.dir}/build/${module}.zip"/>

        <dirname property="current.dir" file="build.xml"/>

        <!-- resources / properties definition-->
        <patternset id="resources">
            <include name="**/*.properties"/>
            <include name="**/*.gif"/>
            <include name="**/*.png"/>
            <include name="**/*.html"/>
            <include name="**/*.xml"/>
            <include name="**/*.txt"/>
        </patternset>

    </target>

    <!-- clean dependencies -->
    <target name="clean" depends="init">
        <delete dir="${build.dir}"/>
    </target>

    <!-- prepare for new build -->
    <target name="prepare" depends="init, module-pre-prepare, common-prepare, module-post-prepare"/>

    <target name="module-pre-prepare"/>

    <target name="module-post-prepare"/>

    <target name="common-prepare" depends="init">

        <echo message="-----------------------------------"/>
        <echo message="    Component: prepare ${module}"/>
        <echo message="-----------------------------------"/>

        <!-- create necessary directories -->
        <mkdir dir="${build.dir}"/>
        <mkdir dir="${classes.dir}"/>

    </target>

    <!-- execute the build -->
    <target name="build" depends="init, module-pre-build, common-build, module-post-build"/>

    <!-- a pre build hook that can be overriden in the modules build.xml -->
    <target name="module-pre-build"/>

    <!-- a post build hook that can be overriden in the modules build.xml -->
    <target name="module-post-build"/>

    <!-- execute the common portion of the build. -->
    <target name="common-build" depends="init">

        <echo message="-----------------------------------"/>
        <echo message="    Component: building ${module}"/>
        <echo message="-----------------------------------"/>

        <javac srcdir="${src.dir}" destdir="${classes.dir}" debug="true"/>

        <copy todir="${classes.dir}" overwrite="true">
            <fileset dir="${src.dir}">
                <patternset refid="resources"/>
            </fileset>
        </copy>

    </target>

    <!-- package artifacts -->
    <target name="package" depends="init, module-pre-package, common-package, module-post-package"/>

    <target name="module-pre-package"/>

    <target name="module-post-package"/>

    <target name="common-package" depends="init">
        
        <echo message="-----------------------------------"/>
        <echo message="    Component: package ${module}"/>
        <echo message="-----------------------------------"/>

        <copy todir="${package.dir}">
            <fileset dir="${classes.dir}" includes="**/*"/>
            <fileset dir="${etc.dir}" includes="**/*"/>
        </copy>

        <jar file="${plugin.jar}" basedir="${package.dir}"/>
        <zip file="${plugin.zip}" basedir="${package.dir}"/>
    </target>

    <!-- the command that rules them all. -->
    <target name="build.plugin" depends="clean, prepare, build, package"/>


</project>
