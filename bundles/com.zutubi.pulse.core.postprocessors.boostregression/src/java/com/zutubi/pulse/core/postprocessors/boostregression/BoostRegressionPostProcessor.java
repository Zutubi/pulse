package com.zutubi.pulse.core.postprocessors.boostregression;

import com.zutubi.pulse.core.postprocessors.api.*;
import static com.zutubi.pulse.core.util.api.XMLStreamUtils.*;
import com.zutubi.util.CollectionUtils;

import javax.xml.stream.XMLStreamException;
import javax.xml.stream.XMLStreamReader;
import java.io.File;
import java.util.Map;

/**
 * Processes the XML reports generated by Boost's process_jam_log utility.
 */
public class BoostRegressionPostProcessor extends XMLTestReportPostProcessorSupport
{
    private static final String ELEMENT_TEST_LOG = "test-log";

    // Actions
    private static final String ELEMENT_COMPILE = "compile";
    private static final String ELEMENT_LIB = "lib";
    private static final String ELEMENT_LINK = "link";
    private static final String ELEMENT_RUN = "run";

    private static final String[] ACTION_ELEMENTS = { ELEMENT_COMPILE, ELEMENT_LIB, ELEMENT_LINK, ELEMENT_RUN };
    
    // Test log attributes
    private static final String ATTRIBUTE_LIBRARY = "library";
    private static final String ATTRIBUTE_TEST_NAME = "test-name";

    // Action attributes
    private static final String ATTRIBUTE_RESULT = "result";

    // Possible results
    private static final String RESULT_FAILURE = "fail";

    private static final String ACTION_CONTENT_PREFIX = "============================[ %s output below ]============================";
    private static final String ACTION_CONTENT_SUFFIX = "============================[ %s output above ]============================\n";

    public BoostRegressionPostProcessor(BoostRegressionPostProcessorConfiguration config)
    {
        super(config);
    }

    protected void extractTestResults(File file, PostProcessorContext ppContext, TestSuiteResult tests)
    {
        process(file, ppContext, tests, new XMLStreamCallback()
        {
            public void process(XMLStreamReader reader, TestSuiteResult tests) throws XMLStreamException
            {
                if (nextElement(reader))
                {
                    processTestLog(reader, tests);
                }
            }
        });
    }

    private void processTestLog(XMLStreamReader reader, TestSuiteResult tests) throws XMLStreamException
    {
        expectStartElement(ELEMENT_TEST_LOG, reader);
        Map<String, String> attributes = getAttributes(reader);

        if (attributes.containsKey(ATTRIBUTE_LIBRARY) && attributes.containsKey(ATTRIBUTE_TEST_NAME))
        {
            String suite = attributes.get(ATTRIBUTE_LIBRARY);
            String name = attributes.get(ATTRIBUTE_TEST_NAME);
            TestSuiteResult suiteResult = getSuite(suite, tests);

            reader.nextTag();

            TestStatus status = TestStatus.PASS;
            StringBuilder detailsBuilder = new StringBuilder();

            while (reader.isStartElement())
            {
                String localname = reader.getLocalName();
                if (isAction(localname))
                {
                    attributes = getAttributes(reader);
                    if (attributes.containsKey(ATTRIBUTE_RESULT) && RESULT_FAILURE.equals(attributes.get(ATTRIBUTE_RESULT)))
                    {
                        status = TestStatus.FAILURE;
                    }
                    String content = reader.getElementText();
                    if(content != null && content.trim().length() > 0)
                    {
                        detailsBuilder.append(String.format(ACTION_CONTENT_PREFIX, localname));
                        detailsBuilder.append(content);
                        detailsBuilder.append(String.format(ACTION_CONTENT_SUFFIX, localname));
                    }
                    reader.nextTag();
                }
                else
                {
                    nextElement(reader);
                }
            }

            String details = (status != TestStatus.PASS) ? detailsBuilder.toString() : null;
            suiteResult.addCase(new TestCaseResult(name, TestResult.DURATION_UNKNOWN, status, details));
        }
        else
        {
            skipElement(reader, false);
        }

        expectEndElement(ELEMENT_TEST_LOG, reader);
    }

    private boolean isAction(String name)
    {
        return CollectionUtils.contains(ACTION_ELEMENTS, name);
    }

    private TestSuiteResult getSuite(String suitePath, TestSuiteResult parentSuite)
    {
        String[] pieces = suitePath.split("/");
        return getSuite(pieces, 0, parentSuite);
    }

    private TestSuiteResult getSuite(String[] path, int index, TestSuiteResult parentSuite)
    {
        if(index == path.length)
        {
            return parentSuite;
        }

        TestSuiteResult suite = parentSuite.findSuite(path[index]);
        if(suite == null)
        {
            suite = new TestSuiteResult(path[index]);
            parentSuite.addSuite(suite);
        }

        return getSuite(path, index + 1, suite);
    }
}
