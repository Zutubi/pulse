<?xml version="1.0" encoding="UTF-8"?>
<project xmlns:ivy="antlib:fr.jayasoft.ivy.ant">
    <import file="../common-build.xml"/>

    <!-- Bundles require special packaging -->
    <target name="common-package">
        <echo message="----------------------------------------------"/>
        <echo message="    Component: package ${ivy.module}              "/>
        <echo message="----------------------------------------------"/>

        <property name="3rd.party.extracted" value="${current.dir}/build/3rdparty/extracted"/>
        <property name="3rd.party.jars" value="${current.dir}/build/3rdparty/jars"/>

        <!-- pick up 3rd party components and extract them. -->
        <mkdir dir="${3rd.party.extracted}"/>
        <mkdir dir="${3rd.party.jars}"/>
        <retrieve-dependencies dest="${3rd.party.jars}" conf="bundled_3rd_party"/>

        <unzip dest="${3rd.party.extracted}">
            <fileset dir="${3rd.party.jars}">
                <include name="*.jar"/>
            </fileset>
        </unzip>

        <jar file="build/${ivy.module}.jar" manifest="resources/META-INF/MANIFEST.MF">
            <fileset dir="${classes.dir}"/>
            <fileset dir="${3rd.party.extracted}">
                <exclude name="META-INF"/>
            </fileset>
            <!-- include license text files. -->
            <fileset dir="${3rd.party.jars}">
                <exclude name="*.jar"/>
            </fileset>
            <fileset dir="resources" excludes="resources/META-INF/MANIFEST.MF"/>
            <path refid="src.export.selection"/>
        </jar>

        <package-src name="${ivy.module}-src.jar" pathref="src.export.selection"/>

        <if>
            <not><isset property="no.tests"/></not>
            <then>
                <jar file="build/${ivy.module}-test.jar">
                    <fileset dir="${test.classes.dir}"/>
                    <path refid="test.export.selection"/>
                </jar>

                <package-src name="${ivy.module}-test-src.jar" pathref="test.export.selection"/>
            </then>
        </if>
    </target>

    <target name="explode.prepackaged.deps" depends="init"
            description="Copy and extract the third party packages for the bundle into the plugin/prepackages/&lt;pluginId&gt; directory.">
        <property name="3rd.party.extracted" value="${current.dir}/build/3rdparty/extracted"/>
        <property name="3rd.party.jars" value="${current.dir}/build/3rdparty/jars"/>

        <!-- pick up 3rd party components and extract them. -->
        <mkdir dir="${3rd.party.extracted}"/>
        <mkdir dir="${3rd.party.jars}"/>
        <retrieve-dependencies dest="${3rd.party.jars}" conf="bundled_3rd_party"/>

        <unzip dest="${3rd.party.extracted}">
            <fileset dir="${3rd.party.jars}">
                <include name="*.jar"/>
            </fileset>
        </unzip>

        <copy todir="${project.root.dir}/plugins/prepackaged/${ivy.module}">
            <fileset dir="${3rd.party.extracted}">
                <exclude name="META-INF/MANIFEST.MF"/>
            </fileset>
            <!-- include license text files. -->
            <fileset dir="${3rd.party.jars}">
                <exclude name="*.jar"/>
            </fileset>
        </copy>
    </target>

</project>
