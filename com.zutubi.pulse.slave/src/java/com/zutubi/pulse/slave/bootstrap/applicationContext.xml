<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE beans PUBLIC "-//SPRING//DTD BEAN//EN" "http://www.springframework.org/dtd/spring-beans.dtd">
<beans>
    <import resource="classpath:/com/zutubi/pulse/core/bootstrap/context/eventContext.xml"/>
    <import resource="classpath:/com/zutubi/pulse/core/bootstrap/context/pluginContext.xml"/>

    <bean id="configRoot" class="org.springframework.beans.factory.config.PropertyPathFactoryBean">
        <property name="targetBeanName">
            <value>configurationManager</value>
        </property>
        <property name="propertyPath">
            <value>systemPaths.configRoot</value>
        </property>
    </bean>

    <bean id="logConfigurationManager" class="com.zutubi.pulse.servercore.util.logging.LogConfigurationManager" init-method="init">
        <property name="logConfiguration">
            <ref local="logConfiguration"/>
        </property>
        <property name="systemPaths">
            <ref local="systemPaths"/>
        </property>
        <property name="logManager">
            <ref local="logManager"/>
        </property>
        <property name="eventManager">
            <ref bean="eventManager"/>
        </property>
    </bean>

    <bean id="logConfiguration" class="org.springframework.beans.factory.config.PropertyPathFactoryBean">
        <property name="targetBeanName">
            <value>configurationManager</value>
        </property>
        <property name="propertyPath">
            <value>appConfig</value>
        </property>
    </bean>

    <bean id="systemPaths" class="org.springframework.beans.factory.config.PropertyPathFactoryBean">
        <property name="targetBeanName">
            <value>configurationManager</value>
        </property>
        <property name="propertyPath">
            <value>systemPaths</value>
        </property>
    </bean>

    <bean id="logManager" class="com.zutubi.pulse.core.util.logging.LogManager">
        <property name="factories">
            <map>
                <entry><key><value>FileHandler</value></key><ref local="fileHandlerFactory"/></entry>
                <entry><key><value>ConsoleHandler</value></key><ref local="consoleHandlerFactory"/></entry>
                <entry><key><value>MemoryHandler</value></key><ref local="memoryHandlerFactory"/></entry>
            </map>
        </property>
    </bean>

    <bean name="jettyServerManager" class="com.zutubi.pulse.servercore.jetty.JettyServerManager"/>

    <bean id="fileHandlerFactory" class="com.zutubi.pulse.servercore.util.logging.FileHandlerFactory">
        <property name="objectFactory">
            <ref bean="objectFactory"/>
        </property>
    </bean>

    <bean id="consoleHandlerFactory" class="com.zutubi.pulse.core.util.logging.ConsoleHandlerFactory"/>
    <bean id="memoryHandlerFactory" class="com.zutubi.pulse.core.util.logging.MemoryHandlerFactory"/>

    <bean id="tokenManager" class="com.zutubi.pulse.servercore.api.AdminTokenManager" autowire="byName" init-method="init"/>

    <bean id="threadPool" class="com.zutubi.pulse.slave.SlaveThreadPool" autowire="byName"/>

    <bean id="slaveQueue" class="com.zutubi.pulse.slave.SlaveQueue" init-method="start"/>

    <bean id="slaveRecipeProcessor" class="com.zutubi.pulse.slave.SlaveRecipeProcessor" autowire="byName"/>

    <bean id="recipeProcessor" class="com.zutubi.pulse.core.RecipeProcessor" autowire="byName"/>

    <bean id="typeRegistry" class="com.zutubi.tove.type.TypeRegistry" autowire="byName"/>

    <bean id="configurationRegistry" class="com.zutubi.pulse.core.tove.config.CoreConfigurationRegistry" autowire="byName" init-method="init"/>

    <bean id="fileLoaderFactory" class="com.zutubi.pulse.core.PulseFileLoaderFactory" autowire="byName" init-method="init"/>

    <bean id="commandFactory" class="com.zutubi.pulse.core.commands.DefaultCommandFactory" autowire="byName"/>

    <bean id="postProcessorFactory" class="com.zutubi.pulse.core.postprocessors.DefaultPostProcessorFactory" autowire="byName"/>

    <bean id="customSerialiserFactory" class="com.zutubi.pulse.servercore.hessian.CustomSerialiserFactory"/>

    <bean id="hessianProxyFactory" class="com.zutubi.pulse.servercore.hessian.CustomHessianProxyFactory" autowire="byName"/>

    <bean id="masterProxyFactory" class="com.zutubi.pulse.slave.MasterProxyFactory" autowire="byName"/>

    <bean id="serviceTokenManager" class="com.zutubi.pulse.servercore.services.ServiceTokenManager" autowire="byName" init-method="init">
        <property name="generate">
            <value>false</value>
        </property>
    </bean>

    <bean id="serverMessagesHandler" class="com.zutubi.pulse.servercore.util.logging.ServerMessagesHandler" autowire="byName" init-method="init"/>

    <!-- Needs a user config root -->
    <bean id="resourceRepository" class="com.zutubi.pulse.core.InMemoryResourceRepository"/>

    <bean id="shutdownManager" class="com.zutubi.pulse.servercore.ShutdownManager">
        <property name="stoppables">
            <list>
                <ref bean="slaveQueue"/>
                <ref bean="jettyServerManager"/>
            </list>
        </property>
    </bean>

    <bean id="ivyProvider" class="com.zutubi.pulse.core.dependency.ivy.DefaultIvyProvider">
        <property name="repositoryBase" value="http://localhost:8080/repository"/>
    </bean>

    <bean id="hessianModuleDescriptorSupportInitialiser" class="com.zutubi.pulse.servercore.dependency.ivy.HessianModuleDescriptorSupportInitialiser" init-method="init">
        <property name="customSerialiserFactory"><ref bean="customSerialiserFactory"/></property>
    </bean>

</beans>
