<?xml version="1.0" encoding="UTF-8"?>
<!-- -->
<!-- -->
<!-- -->
<project name="Pulse" basedir="." xmlns:ivy="antlib:fr.jayasoft.ivy.ant">

    <condition property="on.windows">
        <os family="windows"/>
    </condition>

    <target name="init" depends="module-pre-init, common-init, module-post-init"/>

    <target name="module-pre-init"/>
    
    <target name="module-post-init"/>

    <target name="common-init">

        <property file="build.properties"/>
        <property name="project.repository" value="${project.root.dir}/build/repository"/>

        <dirname property="current.dir" file="ivy.xml"/>

        <property name="package.root" value="build/package/${package.name}"/>
        <property name="version.root" value="${package.root}/versions/${pulse.build}"/>

        <path id="custom.task.path">
            <fileset dir="${project.root.dir}/etc">
                <include name="**/*.jar"/>
            </fileset>
        </path>
        <taskdef resource="net/sf/antcontrib/antlib.xml" classpathref="custom.task.path"/>

        <!-- ivy configuration -->
        <property file="${project.root.dir}/ivy.properties"/>
        <ivy:configure file="${project.root.dir}/ivyconf.xml"/>
        
    </target>

    
    <target name="clean" depends="init, module-pre-clean, common-clean, module-post-clean"/>

    <target name="module-pre-clean"/>

    <target name="module-post-clean"/>

    <target name="common-clean">

        <delete dir="${current.dir}/build"/>
        <delete dir="${current.dir}/pulse-accept"/>

    </target>

    
    <target name="prepare" depends="init, module-pre-prepare, common-prepare, module-post-prepare"/>

    <target name="module-pre-prepare"/>

    <target name="module-post-prepare"/>

    <target name="common-prepare">

        <!-- preparation work... -->
        <mkdir dir="${package.root}"/>

    </target>


    <target name="build" depends="init, module-pre-build, common-build, module-post-build"/>

    <target name="module-pre-build"/>

    <target name="module-post-build"/>

    <target name="common-build">

        <copy file="${project.root.dir}/etc/active-version.txt" todir="${package.root}"/>
        <replace file="${package.root}/active-version.txt">
            <replacefilter token="__BUILD_NUMBER__" value="${pulse.build}"/>
        </replace>

        <!-- foreach. -->
        <foreach target="_copy-package-sources" param="module.name" list="${package.sources}" trim="true">
            <param name="project.root.dir" value="${project.root.dir}"/>
            <param name="package.root" value="${package.root}"/>
        </foreach>

        <move toDir="${version.root}">
            <fileset dir="${package.root}/version"/>
        </move>

        <replace dir="${package.root}" replacefilterfile="${current.dir}/subst.properties">
            <include name="**/*.in"/>
        </replace>
        <move todir="${package.root}">
            <fileset dir="${package.root}"/>
            <mapper type="glob" from="*.in" to="*"/>
        </move>

        <fixcrlf srcdir="${package.root}/bin" eol="lf" eof="remove" includes="**/*.sh"/>
        <chmod perm="755" dir="${package.root}/bin" includes="**/*.sh"/>

        <!-- import all of the external dependencies, and plonk them into the appropriate directories. -->
        <retrieve.dependencies ivyfile="ivy.xml" conf="build" dest="${version.root}/lib"/>
        <retrieve.dependencies ivyfile="ivy.xml" conf="internal" dest="${version.root}/system/plugins/internal"/>
        <retrieve.dependencies ivyfile="ivy.xml" conf="prepackaged" dest="${version.root}/system/plugins/prepackaged"/>

        <!-- handle the boot jar specially -->
        <move tofile="${package.root}/lib/boot.jar">
            <fileset dir="${version.root}/lib" includes="boot-*.jar"/>
        </move>

        <!-- create the zip -->
        <exec executable="zip" dir="${package.root}/..">
            <arg line="-r ${package.name}.zip ${package.name}"/>
        </exec>

        <!-- create the tarball -->
        <tar destfile="build/package/${package.name}.tar.gz" compression="gzip">
            <tarfileset dir="${package.root}/.." mode="755" username="root" group="root">
                <include name="${package.name}/bin/*"/>
            </tarfileset>
            <tarfileset dir="${package.root}/.." username="root" group="root">
                <include name="${package.name}/**/*"/>
                <exclude name="${package.name}/bin/*"/>
            </tarfileset>
        </tar>

        <!-- conditionally build the nsis package, dependant on whether or not the build is running on windows. -->
        <antcall target="_nsis"/>

    </target>

    <target name="_copy-package-sources">
        <copy todir="${package.root}">
            <fileset dir="${project.root.dir}/${module.name}/package" includes="**/*"/>
        </copy>
    </target>

    <target name="_nsis" depends="init" if="on.windows">
        
        <copy file="${project.root.dir}/installer/env.nsh" todir="${package.root}"/>
        <copy file="${project.root.dir}/installer/pulse.ico" todir="${package.root}"/>
        
        <copy file="pulse.nsi.in" tofile="${package.root}/pulse.nsi"/>

        <replace file="${package.root}/pulse.nsi"  replacefilterfile="subst.properties">
            <replacefilter token="__PACKAGE_NAME__" value="${package.name}"/>
            <replacefilter token="__VERSION__" value="${pulse.version}"/>
            <replacefilter token="__PROJECT_ROOT__" value="${project.root.dir}"/>
        </replace>

        <!-- execute the packaging. -->
        <exec executable="makensis" dir="${package.root}">
            <arg line="pulse.nsi"/>
        </exec>
        
    </target>


    <target name="test" depends="init, module-pre-test, common-test, module-post-test"/>

    <target name="module-pre-test"/>

    <target name="module-post-test"/>

    <target name="common-test">

    </target>

    
    <macrodef name="retrieve.dependencies">
        <attribute name="ivyfile"/>
        <attribute name="conf" default="external"/>
        <attribute name="dest" default="lib"/>
        <sequential>
            <!-- resolve the modules ivy file. -->
            <ivy:resolve file="@{ivyfile}" conf="@{conf}"/>
            <ivy:deliver deliverpattern="${project.repository}/[module]/ivy-[revision].xml"/>
            <ivy:retrieve pattern="@{dest}/[artifact]-[revision].[ext]" validate="true" conf="@{conf}"/>
        </sequential>
    </macrodef>

</project>
