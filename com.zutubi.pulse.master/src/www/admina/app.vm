<!DOCTYPE html>
<html lang="en" style="height: 100%">
<head>
    <link href="${base}/css/reset.css" rel="stylesheet"/>

    <link href="${base}/css/kendo/kendo.common-material.min.css" rel="stylesheet"/>
    <link href="${base}/css/kendo/kendo.material.min.css" rel="stylesheet"/>
    <link href="${base}/css/admina.css" rel="stylesheet"/>

    <script>
        window.baseUrl = "${base}";
        adminPath = "/${path}/";
    </script>

    #javascript()
        zutubi/admin/package.js
    #end

    <title>Pulse Admin</title>
</head>
<body>
<div id="navbar">
</div>

<div id="content">
    <div id="notification"></div>
    <div id="config-view" style="height: 100%; width: 100%">

    </div>
</div>

<div id="footer">
    <b>::</b> <a href="http://zutubi.com/products/pulse/">pulse</a> ($version_number #$build_number)
    <b>::</b> copyright &copy; 2005-2015 <a href="http://zutubi.com/">zutubi pty ltd</a> <b>::</b>
    <a href="http://jira.zutubi.com/">report bug/request feature</a>
</div>

<script>
    var notificationElement = $("#notification");
    notificationElement.kendoNotification({
        autoHideAfter: 7000,
        allowHideAfter: 1000,
        button: true,
        hideOnClick: false,
        position: {
            top: 50
        },
        stacking: "down"
    });

    var notificationWidget = notificationElement.data("kendoNotification");

    function zaReportSuccess(message)
    {
        notificationWidget.success(message);
    }

    function zaReportError(message)
    {
        notificationWidget.error(message);
    }

    function zaAjaxError(jqXHR)
    {
        var message = "";
        if (jqXHR.statusText)
        {
            message = jqXHR.statusText + " ";
        }

        message += "(" + jqXHR.status + ")";

        try
        {
            details = JSON.parse(jqXHR.responseText);
            if (details.message)
            {
                message += ": " + details.message;
            }
        }
        catch(e)
        {
            // Do nothing.
        }

        return message;
    }

    var router = new kendo.Router({
        root: window.baseUrl + "/admina",
        pushState: true,
        routeMissing: function(e)
        {
            notificationWidget.error("Unknown admin path '" + e.url + "', redirecting.")
            router.navigate("/");
        }
    });

    function showScope(scope)
    {
        if (window.configPanel)
        {
            window.configPanel.destroy();
            delete window.configPanel;
        }

        if (!window.scopePanel)
        {
            window.scopePanel = new Zutubi.admin.ScopePanel("#config-view")
        }

        window.scopePanel.setScope(scope);
    }

    function subpath(path, begin, end)
    {
        var elements = path.split("/");

        if (typeof end === "undefined")
        {
            end = elements.length;
        }

        elements = elements.slice(begin, end);
        return elements.join("/");
    }

    function showConfig(path, templated)
    {
        var rootIndex = templated ? 2 : 1,
            rootPath = subpath(path, 0, rootIndex),
            configPath = subpath(path, rootIndex);

        if (window.scopePanel)
        {
            window.scopePanel.destroy();
            delete window.scopePanel;
        }

        if (!window.configPanel)
        {
            window.configPanel = new Zutubi.admin.ConfigPanel("#config-view");
            window.configPanel.bind("pathselect", function (e) {
                router.navigate("/config/" + e.path, true);
            });
        }

        window.configPanel.setPaths(rootPath, configPath);
    }

    router.route("/", function(path)
    {
        router.navigate("/hierarchy/projects/");
    });

    router.route("/hierarchy/projects/(:name)", function(path, name)
    {
        window.navbar.selectScope("projects");
        showScope("projects", name);
    });

    router.route("/config/projects/*path", function(path)
    {
        window.navbar.selectScope("projects");
        showConfig("projects/" + path, true);
    });

    router.route("/hierarchy/agents/(:name)", function(path, name)
    {
        window.navbar.selectScope("agents");
        showScope("agents", name);
    });

    router.route("/config/agents/*path", function(path)
    {
        window.navbar.selectScope("agents");
        if (path)
        {
            showConfig("agents/" + path, true);
        }
    });

    router.route("/config/settings/*path", function(path)
    {
        window.navbar.selectScope("settings");
        showConfig("settings/" + (path ? path : ""), false);
    });

    router.route("/config/users/*path", function(path)
    {
        window.navbar.selectScope("users");
        showConfig("users/" + (path ? path : ""), false);
    });

    router.route("/config/groups/*path", function(path)
    {
        window.navbar.selectScope("groups");
        showConfig("groups/" + (path ? path : ""), false);
    });

    router.route("/plugins(/:id)", function(id)
    {
        window.navbar.selectScope("plugins");
        console.log("plugin: " + id);
    });

    $(document).ready(function()
    {
        window.navbar = $("#navbar").kendoZaNavbar().data("kendoZaNavbar");
        window.navbar.bind("scope-selected", function(e)
        {
            if (e.scope === "projects" || e.scope === "agents")
            {
                router.navigate("/hierarchy/" + e.scope + "/");
            }
            else if (e.scope === "plugins")
            {
                router.navigate("/plugins/");
            }
            else
            {
                router.navigate("/config/" + e.scope + "/");
            }
        });

        router.start();
    });
</script>
</body>
</html>
