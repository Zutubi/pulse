<?xml version="1.0" encoding="UTF-8"?>
<project name="Cinnamon Bob" default="default" basedir=".">

    <property file="build.properties"/>

    <path id="lib.path">
        <fileset dir="lib">
            <include name="**/*.jar"/>
        </fileset>
    </path>

    <patternset id="resources">
        <include name="**/*.properties"/>
        <include name="**/*.png"/>
    </patternset>

    <target name="clean" description="Clean up after myself.">
        <delete dir="build"/>
    </target>

    <target name="prepare" description="Prepares build directory.">
        <tstamp/>
        <mkdir dir="build"/>
    </target>

    <target name="build" description="Compile all of the java source.">

        <mkdir dir="build/java/classes"/>
        <javac srcdir="src/main/java" destdir="build/java/classes" debug="on">
            <classpath refid="lib.path"/>
        </javac>

        <copy todir="build/java/classes" overwrite="true">
            <fileset dir="src/main/java">
                <patternset refid="resources"/>
            </fileset>
        </copy>

        <mkdir dir="build/test/classes"/>
        <javac srcdir="src/test/java" destdir="build/test/classes" debug="on">
            <classpath refid="lib.path"/>
            <classpath location="build/java/classes"/>
        </javac>

        <copy todir="build/test/classes" overwrite="true">
            <fileset dir="src/test/java">
                <patternset refid="resources"/>
            </fileset>
        </copy>

    </target>

    <target name="test" description="Run the project's tests.">
        <mkdir dir="build/test/report"/>
        <junit forkmode="once">
            <classpath>
                <path refid="lib.path"/>
                <pathelement location="build/java/classes"/>
                <pathelement location="build/test/classes"/>
            </classpath>
            <sysproperty key="tests.data.dir" value="src/test/data"/>

            <batchtest fork="true" todir="build/test/report">
                <fileset dir="src/test/java" includes="**/*Test.java"/>
                <formatter type="xml"/>
                <formatter type="plain"/>
            </batchtest>
        </junit>
    </target>

    <target name="default" depends="clean, build, test" description="Run a clean build by default."/>

    <target name="jar" depends="build">
        <jar file="build/bob.jar" basedir="build/java/classes"/>
    </target>

    <target name="war">
        <war destfile="build/bob.war" webxml="src/www/WEB-INF/web.xml">
            <fileset dir="src/www">
                <exclude name="WEB-INF/web.xml"/>
            </fileset>
            <lib dir="lib">
                <include name="**/*.jar"/>
            </lib>
        </war>
    </target>

    <target name="pkg" depends="jar, war">
        <property name="zip.root" value="bob-dev"/>
        <zip destfile="build/bob.zip">
            <zipfileset dir="src/bin" prefix="${zip.root}/bin"/>
            <zipfileset dir="build" includes="bob.jar" fullpath="${zip.root}/lib/bob.jar"/>
            <zipfileset dir="build" includes="bob.war" fullpath="${zip.root}/lib/bob.war"/>
            <zipfileset dir="lib" includes="*.jar" prefix="${zip.root}/lib"/>
            <zipfileset dir="src/main/config" includes="*.xml" prefix="${zip.root}/config"/>
            <zipfileset dir="src/main/templates" includes="**/*.vm" prefix="${zip.root}/templates"/>
            <zipfileset dir="etc" includes="delete-me.txt" fullpath="${zip.root}/work/delete-me.txt"/>
        </zip>
    </target>

    <target name="deploy">
        <delete dir="deploy/bob-dev"/>
        <mkdir dir="deploy"/>
        <unzip src="build/bob.zip" dest="deploy"/>
    </target>


    <target name="bob.start" depends="default">
        <copy todir="build/root/config">
            <fileset dir="src/main/config">
                <include name="**/*"/>
            </fileset>
        </copy>
        <mkdir dir="build/root/log"/>
        <java classname="com.cinnamonbob.command.Bootstrap" fork="true" spawn="true">
            <classpath refid="lib.path"/>
            <classpath location="build/java/classes"/>
            <classpath location="src/main/templates"/>
            <sysproperty key="java.util.logging.config.file" value="./etc/logging.properties"/>
            <sysproperty key="root.dir" value="build/root"/>
            <arg value="--start"/>
        </java>
    </target>

    <target name="bob.run" depends="default">
        <copy todir="build/root/config">
            <fileset dir="src/main/config">
                <include name="**/*"/>
            </fileset>
        </copy>
        <copy todir="build/root/templates">
            <fileset dir="src/main/templates">
                <include name="**/*"/>
            </fileset>
        </copy>
        <mkdir dir="build/root/log"/>
        <java classname="com.cinnamonbob.command.Bootstrap" fork="true">
            <classpath refid="lib.path"/>
            <classpath location="build/java/classes"/>
            <classpath location="src/main/templates"/>
            <sysproperty key="java.util.logging.config.file" value="./etc/logging.properties"/>
            <sysproperty key="root.dir" value="build/root"/>
            <arg value="--start"/>
        </java>
    </target>

    <target name="bob.stop">
        <java classname="com.cinnamonbob.command.Bootstrap" fork="true">
            <classpath refid="lib.path"/>
            <classpath location="build/java/classes"/>
            <sysproperty key="java.util.logging.config.file" value="./etc/logging.properties"/>
            <arg value="--stop"/>
        </java>
    </target>

    <target name="bob.build">
        <java classname="com.cinnamonbob.command.Bootstrap" fork="true">
            <classpath refid="lib.path"/>
            <classpath location="build/java/classes"/>
            <sysproperty key="java.util.logging.config.file" value="./etc/logging.properties"/>
            <sysproperty key="root.dir" value="./deploy/bob-dev"/>
            <arg value="--build=test-project"/>
        </java>
    </target>
    <target name="bob.usage">
        <java classname="com.cinnamonbob.command.Bootstrap" fork="true">
            <classpath refid="lib.path"/>
            <classpath location="build/java/classes"/>
            <sysproperty key="java.util.logging.config.file" value="./etc/logging.properties"/>
            <arg value="--usage"/>
        </java>
    </target>
    <target name="bob.help">
        <java classname="com.cinnamonbob.command.Bootstrap" fork="true">
            <classpath refid="lib.path"/>
            <classpath location="build/java/classes"/>
            <sysproperty key="java.util.logging.config.file" value="./etc/logging.properties"/>
            <arg value="--help"/>
        </java>
    </target>

</project>