<?xml version="1.0" encoding="UTF-8"?>
<!-- -->
<!-- -->
<!-- -->
<project name="Cinnamon Bob" basedir="." xmlns:ivy="antlib:fr.jayasoft.ivy.ant">

    <property name="bob.version" value="0.2"/>

    <target name="clean">
        <delete dir="build"/>
        <delete dir=".ivy-cache/cinnamonbob"/>
    </target>

    <target name="clean.all" depends="clean">
        <foreach target="clean"/>
    </target>

    <target name="build.core">
        <ant inheritAll="false" dir="core" antfile="build.xml" target="build.module"/>
    </target>

    <target name="build.server-core" depends="build.core">
        <ant inheritAll="false" dir="server-core" antfile="build.xml" target="build.module"/>
    </target>

    <target name="build.local" depends="build.core">
        <ant inheritAll="false" dir="local" antfile="build.xml" target="build.module"/>
    </target>

    <target name="build.master" depends="build.server-core">
        <ant inheritAll="false" dir="master" antfile="build.xml" target="build.module"/>
    </target>

    <target name="build.slave" depends="build.server-core">
        <ant inheritAll="false" dir="slave" antfile="build.xml" target="build.module"/>
    </target>

    <target name="package.local" depends="init, build.local">

        <property name="package.root" value="build/package"/>
        <delete dir="${package.root}"/>
        <mkdir dir="${package.root}"/>

        <copy todir="${package.root}/bin">
            <fileset dir="core/src/bin" includes="**/*"/>
            <fileset dir="local/src/bin" includes="**/*"/>
        </copy>

        <fixcrlf srcdir="${package.root}/bin" eol="lf" eof="remove" includes="**/*.sh"/>
        <chmod perm="755" dir="${package.root}/bin" includes="**/*.sh"/>

        <retrieve.package conf="local" dest="${package.root}/lib"/>

        <!-- place holder for package documentation -->
        <copy todir="${package.root}/docs">
            <fileset dir="etc" includes="delete-me.txt"/>
        </copy>
        <!-- place holder for the log directory -->
        <copy todir="${package.root}/system/log">
            <fileset dir="etc" includes="delete-me.txt"/>
        </copy>

        <zip destfile="build/bob-local-${bob.version}.zip">
            <zipfileset dir="build/package" includes="**/*" prefix="bob-local-${bob.version}"/>
        </zip>

    </target>

    <target name="package.master" depends="init, build.local, build.master">

        <property name="package.name" value="bob-master-${bob.version}"/>
        <property name="package.root" value="build/package/${package.name}"/>

        <delete dir="${package.root}"/>
        <mkdir dir="${package.root}"/>

        <copy todir="${package.root}/bin">
            <fileset dir="core/src/bin" includes="**/*"/>
            <fileset dir="local/src/bin" includes="**/*"/>
            <fileset dir="server-core/src/bin" includes="**/*"/>
            <fileset dir="master/src/bin" includes="**/*"/>
        </copy>

        <fixcrlf srcdir="${package.root}/bin" eol="lf" eof="remove" includes="**/*.sh"/>
        <chmod perm="755" dir="${package.root}/bin" includes="**/*.sh" verbose="true"/>

        <retrieve.package conf="local" dest="${package.root}/lib"/>
        <retrieve.package conf="master" dest="${package.root}/lib"/>
        <retrieve.package conf="master" dest="${package.root}/system/www/WEB-INF/lib"/>

        <!-- place holder for package documentation -->
        <copy todir="${package.root}/docs">
            <fileset dir="etc" includes="delete-me.txt"/>
        </copy>
        <copy todir="${package.root}/system/templates">
            <fileset dir="master/src/templates" includes="**/*.vm **/*.ftl"/>
        </copy>
        <!-- place holder for the database directory -->
        <copy todir="${package.root}/system/database">
            <fileset dir="etc" includes="delete-me.txt"/>
        </copy>
        <!-- place holder for the log directory -->
        <copy todir="${package.root}/system/log">
            <fileset dir="etc" includes="delete-me.txt"/>
        </copy>
        <copy todir="${package.root}/system/www">
            <fileset dir="server-core/src/www" includes="**/*"/>
            <fileset dir="master/src/www" includes="**/*"/>
        </copy>

        <!-- /config is for user configuration properties -->
        <copy todir="${package.root}/system/config">
            <fileset dir="master/etc" includes="bob-defaults.properties,logging.properties"/>
        </copy>

       <!-- the ant zip command doesn't preserve permissions, so we call out to zip -->
        <exec executable="zip" dir="${package.root}/..">
            <arg line="-r ../${package.name}.zip ${package.name}"/>
        </exec>

        <tar destfile="build/${package.name}.tgz" compression="gzip">
            <tarfileset dir="${package.root}/.." mode="755" username="root" group="root">
                <include name="${package.name}/bin/*"/>
            </tarfileset>
            <tarfileset dir="${package.root}/.." username="root" group="root">
                <include name="${package.name}/**/*"/>
                <exclude name="${package.name}/bin/*"/>
            </tarfileset>
        </tar>
    </target>

    <target name="package.slave" depends="init, build.local, build.slave">

        <property name="package.root" value="build/package"/>
        <delete dir="${package.root}"/>
        <mkdir dir="${package.root}"/>

        <copy todir="${package.root}/bin">
            <fileset dir="core/src/bin" includes="**/*"/>
            <fileset dir="local/src/bin" includes="**/*"/>
            <fileset dir="server-core/src/bin" includes="**/*"/>
            <fileset dir="slave/src/bin" includes="**/*"/>
        </copy>

        <fixcrlf srcdir="${package.root}/bin" eol="lf" eof="remove" includes="**/*.sh"/>
        <chmod perm="755" dir="${package.root}/bin" includes="**/*.sh"/>

        <retrieve.package conf="local" dest="${package.root}/lib"/>
        <retrieve.package conf="slave" dest="${package.root}/lib"/>
        <retrieve.package conf="slave" dest="${package.root}/system/www/WEB-INF/lib"/>

        <!-- place holder for package documentation -->
        <copy todir="${package.root}/docs">
            <fileset dir="etc" includes="delete-me.txt"/>
        </copy>
        <!-- /config is for user configuration properties -->
        <copy todir="${package.root}/config">
            <fileset dir="master/etc" includes="bob.properties"/>
        </copy>
        <!-- place holder for the logs directory -->
        <copy todir="${package.root}/system/logs">
            <fileset dir="etc" includes="delete-me.txt"/>
        </copy>
        <copy todir="${package.root}/system/www">
            <fileset dir="slave/src/www" includes="**/*"/>
        </copy>
        <!-- /system/config is for system configuration files - not changed unless there is a problem... -->
        <copy todir="${package.root}/system/config">
            <fileset dir="master/etc" includes="log.properties"/>
        </copy>


        <zip destfile="build/bob-slave-${bob.version}.zip">
            <zipfileset dir="build/package" includes="**/*" prefix="bob-slave-${bob.version}"/>
        </zip>

    </target>


    <target name="init">
        <property name="project.root.dir" value="."/>
        <property name="project.repository" value="${project.root.dir}/build/repository"/>
    </target>

    <target name="resolve.lib" depends="init">
    	<resolve.dependencies module="core"/>
    	<resolve.dependencies module="server-core"/>
    	<resolve.dependencies module="local"/>
    	<resolve.dependencies module="master"/>
    	<resolve.dependencies module="slave"/>
    </target>

    <target name="refresh.lib" depends="clean, init">

        <delete dir="lib"/>
        <mkdir dir="lib"/>

        <ivy:configure file="ivyconf.xml"/>
        <retrieve.dependencies module="core"/>
        <retrieve.dependencies module="server-core"/>
        <retrieve.dependencies module="local"/>
        <retrieve.dependencies module="master"/>
        <retrieve.dependencies module="slave"/>

    </target>

    <macrodef name="retrieve.dependencies">
        <attribute name="module"/>
        <attribute name="conf" default="external"/>
        <sequential>
            <ivy:resolve file="@{module}/ivy.xml" conf="@{conf}"/>
            <ivy:deliver deliverpattern="${project.repository}/[module]/ivy-[revision].xml"/>
            <ivy:retrieve validate="true" conf="@{conf}"/>
        </sequential>
    </macrodef>

    <macrodef name="resolve.dependencies">
        <attribute name="module"/>
        <attribute name="conf" default="external"/>
        <sequential>
            <ivy:resolve file="@{module}/ivy.xml" conf="@{conf}"/>
            <ivy:retrieve validate="true" conf="@{conf}"/>
        </sequential>
    </macrodef>


    <macrodef name="retrieve.package">
        <attribute name="conf"/>
        <attribute name="dest"/>
        <sequential>
            <ivy:resolve file="ivy.xml" conf="@{conf}"/>
            <ivy:deliver deliverpattern="${project.repository}/[module]/ivy-[revision].xml"/>
            <ivy:retrieve pattern="@{dest}/[artifact]-[revision].[ext]" validate="true" conf="@{conf}"/>
        </sequential>
    </macrodef>

    <macrodef name="foreach">
        <attribute name="target"/>
        <sequential>
            <ant inheritAll="false" dir="core" antfile="build.xml" target="@{target}"/>
            <ant inheritAll="false" dir="local" antfile="build.xml" target="@{target}"/>
            <ant inheritAll="false" dir="server-core" antfile="build.xml" target="@{target}"/>
            <ant inheritAll="false" dir="master" antfile="build.xml" target="@{target}"/>
            <ant inheritAll="false" dir="slave" antfile="build.xml" target="@{target}"/>
        </sequential>
    </macrodef>


</project>
