<?xml version="1.0" encoding="UTF-8"?>
<project name="Cinnamon Bob" default="default" basedir=".">

    <property file="build.properties"/>

    <property name="version" value="dev"/>

    <path id="lib.path">
        <fileset dir="lib">
            <include name="**/*.jar"/>
        </fileset>
    </path>

    <patternset id="resources">
        <include name="**/*.properties"/>
        <include name="**/*.png"/>
        <include name="**/*.xml"/>
    </patternset>

    <target name="clean" description="Clean up after myself.">
        <delete dir="build"/>
    </target>

    <target name="prepare" description="Prepares build directory.">
        <tstamp/>
        <mkdir dir="build"/>
    </target>

    <target name="build" description="Compile all of the java source.">

        <mkdir dir="build/java/classes"/>
        <javac srcdir="src/main/java" destdir="build/java/classes" debug="on">
            <classpath refid="lib.path"/>
        </javac>

        <copy todir="build/java/classes" overwrite="true">
            <fileset dir="src/main/java">
                <patternset refid="resources"/>
            </fileset>
        </copy>

        <mkdir dir="build/test/classes"/>
        <javac srcdir="src/test/java" destdir="build/test/classes" debug="on">
            <classpath refid="lib.path"/>
            <classpath location="build/java/classes"/>
        </javac>

        <copy todir="build/test/classes" overwrite="true">
            <fileset dir="src/test/java">
                <patternset refid="resources"/>
            </fileset>
        </copy>

    </target>

    <target name="test" description="Run the project's tests.">
        <mkdir dir="build/test/report"/>
        <junit forkmode="once" haltonfailure="true">
            <classpath>
                <path refid="lib.path"/>
                <pathelement location="build/java/classes"/>
                <pathelement location="build/test/classes"/>
            </classpath>
            <sysproperty key="tests.data.dir" value="src/test/data"/>

            <batchtest fork="true" todir="build/test/report">
                <fileset dir="src/test/java" includes="**/*Test.java"/>
                <formatter type="xml"/>
                <formatter type="plain"/>
            </batchtest>
        </junit>
    </target>

    <target name="default" depends="clean, build, test" description="Run a clean build by default."/>

    <target name="jar" depends="build">
        <jar file="build/bob-${version}.jar" basedir="build/java/classes"/>
    </target>

    <target name="package" depends="jar">
        <mkdir dir="build/package"/>
        <property name="package.root" value="build/package/bob-${version}"/>

        <!-- copy all the files into the package.root directory, run any processing -->
        <!-- if required, then zip them up. Remember to put the delete-me.txt -->
        <!-- file into empty directories -->

        <copy todir="${package.root}/bin">
            <fileset dir="src/bin" includes="**/*"/>
        </copy>

        <fixcrlf srcdir="${package.root}/bin" eol="lf" eof="remove" includes="**/*.sh"/>

        <copy todir="${package.root}/lib">
            <fileset dir="lib">
                <include name="**/*.jar"/>
                <include name="**/*LICENSE.txt"/>
                <exclude name="junit*.jar"/>
            </fileset>
            <fileset dir="build">
                <include name="bob-${version}.jar"/>
            </fileset>
        </copy>

        <copy todir="${package.root}/config">
            <fileset dir="src/main/config">
                <include name="**/*.xml"/>
            </fileset>
        </copy>

        <copy todir="${package.root}/docs">
            <fileset dir="src/etc" includes="delete-me.txt"/>
        </copy>

        <copy todir="${package.root}/system/templates">
            <fileset dir="src/templates" includes="**/*.vm"/>
        </copy>

        <copy todir="${package.root}/work">
            <fileset dir="src/etc" includes="delete-me.txt"/>
        </copy>

        <copy todir="${package.root}/system/www">
            <fileset dir="src/www" includes="**/*"/>
        </copy>

        <copy todir="${package.root}/system/config">
            <fileset dir="src/etc" includes="logging.properties"/>
        </copy>

        <zip destfile="build/bob-${version}.zip" basedir="build/package"/>

    </target>

    <target name="deploy">
        <delete dir="deploy"/>
        <mkdir dir="deploy"/>
        <unzip src="build/bob-${version}.zip" dest="deploy"/>
    </target>

    <target name="bob.start" depends="default">
        <copy todir="build/root/config">
            <fileset dir="src/main/config">
                <include name="**/*"/>
            </fileset>
        </copy>
        <mkdir dir="build/root/log"/>
        <java classname="com.cinnamonbob.command.Bootstrap" fork="true" spawn="true">
            <classpath refid="lib.path"/>
            <classpath location="build/java/classes"/>
            <classpath location="src/main/templates"/>
            <sysproperty key="java.util.logging.config.file" value="./etc/logging.properties"/>
            <sysproperty key="root.dir" value="build/root"/>
            <arg value="start"/>
        </java>
    </target>

    <target name="bob.build">
        <java classname="com.cinnamonbob.command.Bootstrap" fork="true">
            <classpath refid="lib.path"/>
            <classpath location="build/java/classes"/>
            <sysproperty key="java.util.logging.config.file" value="./etc/logging.properties"/>
            <sysproperty key="root.dir" value="./deploy/bob-dev"/>
            <arg value="build"/>
            <arg value="test-project"/>
        </java>
    </target>

    <target name="pkg" depends="package" description="The 'pkg' target has been renamed to 'package'."/>

</project>