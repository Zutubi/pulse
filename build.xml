<?xml version="1.0" encoding="UTF-8"?>
<!-- -->
<!-- -->
<!-- -->
<project name="Cinnamon Bob" basedir="." xmlns:ivy="antlib:fr.jayasoft.ivy.ant">

    <target name="clean">
        <delete dir="build"/>
    </target>

    <target name="build.core">
        <ant inheritAll="false" dir="core" antfile="ant.xml" target="build.module"/>
    </target>

    <target name="build.server-core" depends="build.core">
        <ant inheritAll="false" dir="server-core" antfile="ant.xml" target="build.module"/>
    </target>

    <target name="build.local" depends="build.core">
        <ant inheritAll="false" dir="local" antfile="ant.xml" target="build.module"/>
    </target>

    <target name="build.master" depends="build.server-core">
        <ant inheritAll="false" dir="master" antfile="ant.xml" target="build.module"/>
    </target>

    <target name="build.slave" depends="build.server-core">
        <ant inheritAll="false" dir="slave" antfile="ant.xml" target="build.module"/>
    </target>

    <target name="package.local" depends="init, build.local">

        <mkdir dir="build/package"/>
        <property name="package.root" value="build/package/bob-local-0.2"/>

        <copy todir="${package.root}/bin">
            <fileset dir="core/src/bin" includes="**/*"/>
            <fileset dir="local/src/bin" includes="**/*"/>
        </copy>

        <fixcrlf srcdir="${package.root}/bin" eol="lf" eof="remove" includes="**/*.sh"/>

        <retrieve.package conf="local" dest="${package.root}/lib"/>

        <!-- place holder for package documentation -->
        <copy todir="${package.root}/docs">
            <fileset dir="etc" includes="delete-me.txt"/>
        </copy>
        <!-- place holder for the logs directory -->
        <copy todir="${package.root}/system/logs">
            <fileset dir="etc" includes="delete-me.txt"/>
        </copy>
        <zip destfile="build/bob-local-0.2.zip" basedir="build/package"/>

    </target>

    <target name="package.master" depends="init, build.local, build.master">

        <property name="package.name" value="bob-master-0.2"/>

        <mkdir dir="build/package"/>
        <property name="package.root" value="build/package/${package.name}"/>

        <copy todir="${package.root}/bin">
            <fileset dir="core/src/bin" includes="**/*"/>
            <fileset dir="local/src/bin" includes="**/*"/>
            <fileset dir="server-core/src/bin" includes="**/*"/>
            <fileset dir="master/src/bin" includes="**/*"/>
        </copy>

        <fixcrlf srcdir="${package.root}/bin" eol="lf" eof="remove" includes="**/*.sh"/>

        <retrieve.package conf="local" dest="${package.root}/lib"/>
        <retrieve.package conf="master" dest="${package.root}/system/www/WEB-INF/lib"/>

        <!-- place holder for package documentation -->
        <copy todir="${package.root}/docs">
            <fileset dir="etc" includes="delete-me.txt"/>
        </copy>
        <copy todir="${package.root}/system/templates">
            <fileset dir="master/src/templates" includes="**/*.vm"/>
        </copy>
        <!-- place holder for the database directory -->
        <copy todir="${package.root}/system/database">
            <fileset dir="etc" includes="delete-me.txt"/>
        </copy>
        <!-- place holder for the project work directory -->
        <copy todir="${package.root}/work">
            <fileset dir="etc" includes="delete-me.txt"/>
        </copy>
        <!-- place holder for the logs directory -->
        <copy todir="${package.root}/system/logs">
            <fileset dir="etc" includes="delete-me.txt"/>
        </copy>
        <copy todir="${package.root}/system/www">
            <fileset dir="master/src/www" includes="**/*"/>
        </copy>
        <copy todir="${package.root}/system/config">
            <fileset dir="master/etc" includes="*.properties"/>
        </copy>

        <zip destfile="build/${package.name}.zip" basedir="build/package"/>

    </target>


    <target name="init">
        <property name="project.root.dir" value="."/>
        <property name="project.repository" value="${project.root.dir}/build/repository"/>
    </target>

    <target name="refresh.lib" depends="clean, init">

        <delete dir="lib"/>
        <mkdir dir="lib"/>

        <ivy:configure file="ivyconf.xml"/>
        <retrieve.dependencies module="core"/>
        <retrieve.dependencies module="server-core"/>
        <retrieve.dependencies module="local"/>
        <retrieve.dependencies module="master"/>
        <retrieve.dependencies module="slave"/>

    </target>

    <macrodef name="retrieve.dependencies">
        <attribute name="module"/>
        <attribute name="conf" default="external"/>
        <sequential>
            <ivy:resolve file="@{module}/ivy.xml" conf="@{conf}"/>
            <ivy:deliver deliverpattern="${project.repository}/[module]/ivy-[revision].xml"/>
            <ivy:retrieve validate="true" conf="@{conf}"/>
        </sequential>
    </macrodef>


    <macrodef name="retrieve.package">
        <attribute name="conf"/>
        <attribute name="dest"/>
        <sequential>
            <ivy:resolve file="ivy.xml" conf="@{conf}"/>
            <ivy:deliver deliverpattern="${project.repository}/[module]/ivy-[revision].xml"/>
            <ivy:retrieve pattern="@{dest}/[artifact]-[revision].[ext]" validate="true" conf="@{conf}"/>
        </sequential>
    </macrodef>

</project>
